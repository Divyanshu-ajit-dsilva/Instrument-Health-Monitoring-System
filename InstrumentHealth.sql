CREATE USER instrumentdb IDENTIFIED BY "InstrumentDb@123"
DEFAULT TABLESPACE USERS
QUOTA UNLIMITED ON USERS;

GRANT CONNECT, RESOURCE, CREATE VIEW TO instrumentdb;
GRANT CREATE SESSION TO instrumentdb;

-- Create Instruments table
CREATE TABLE INSTRUMENTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INSTRUMENT_CODE VARCHAR2(50) NOT NULL UNIQUE,
    INSTRUMENT_NAME VARCHAR2(200) NOT NULL,
    DEPARTMENT VARCHAR2(100),
    LOCATION VARCHAR2(100),
    MANUFACTURER VARCHAR2(100),
    MODEL VARCHAR2(50),
    SERIAL_NUMBER VARCHAR2(50),
    INSTALLATION_DATE DATE,
    LAST_MAINTENANCE_DATE DATE,
    NEXT_MAINTENANCE_DATE DATE,
    STATUS NUMBER(1) NOT NULL,
    NOTES VARCHAR2(500),
    CREATED_BY VARCHAR2(100),
    CREATED_DATE DATE DEFAULT SYSDATE,
    LAST_MODIFIED_BY VARCHAR2(100),
    LAST_MODIFIED_DATE DATE,
    IS_APPROVED NUMBER(1) DEFAULT 0,
    APPROVED_BY VARCHAR2(100),
    APPROVED_DATE DATE
);

-- Create Maintenance Records table
CREATE TABLE MAINTENANCE_RECORDS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INSTRUMENT_ID NUMBER NOT NULL,
    MAINTENANCE_DATE DATE NOT NULL,
    MAINTENANCE_TYPE VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(1000) NOT NULL,
    PERFORMED_BY VARCHAR2(100),
    COST NUMBER(10,2) DEFAULT 0,
    STATUS_AFTER_MAINTENANCE NUMBER(1),
    NOTES VARCHAR2(500),
    CREATED_BY VARCHAR2(100),
    CREATED_DATE DATE DEFAULT SYSDATE,
    IS_APPROVED NUMBER(1) DEFAULT 0,
    APPROVED_BY VARCHAR2(100),
    APPROVED_DATE DATE,
    CONSTRAINT FK_MAINTENANCE_INSTRUMENT 
        FOREIGN KEY (INSTRUMENT_ID) REFERENCES INSTRUMENTS(ID) ON DELETE CASCADE
);

-- Create indexes for better performance
CREATE INDEX IDX_INSTRUMENTS_DEPT ON INSTRUMENTS(DEPARTMENT);
CREATE INDEX IDX_INSTRUMENTS_STATUS ON INSTRUMENTS(STATUS);
CREATE INDEX IDX_INSTRUMENTS_APPROVED ON INSTRUMENTS(IS_APPROVED);
CREATE INDEX IDX_MAINTENANCE_INSTRUMENT ON MAINTENANCE_RECORDS(INSTRUMENT_ID);
CREATE INDEX IDX_MAINTENANCE_DATE ON MAINTENANCE_RECORDS(MAINTENANCE_DATE);

-- Create views for reporting
CREATE OR REPLACE VIEW VW_INSTRUMENT_SUMMARY AS
SELECT 
    I.ID,
    I.INSTRUMENT_CODE,
    I.INSTRUMENT_NAME,
    I.DEPARTMENT,
    I.LOCATION,
    I.STATUS,
    I.NEXT_MAINTENANCE_DATE,
    I.IS_APPROVED,
    CASE 
        WHEN I.NEXT_MAINTENANCE_DATE < SYSDATE THEN 'OVERDUE'
        WHEN I.NEXT_MAINTENANCE_DATE <= SYSDATE + 7 THEN 'DUE_SOON'
        WHEN I.NEXT_MAINTENANCE_DATE <= SYSDATE + 30 THEN 'DUE_LATER'
        ELSE 'NOT_DUE'
    END AS MAINTENANCE_STATUS,
    (SELECT COUNT(*) FROM MAINTENANCE_RECORDS MR WHERE MR.INSTRUMENT_ID = I.ID) AS MAINTENANCE_COUNT
FROM INSTRUMENTS I;

-- Insert sample data
INSERT INTO INSTRUMENTS (
    INSTRUMENT_CODE, INSTRUMENT_NAME, DEPARTMENT, LOCATION, 
    MANUFACTURER, MODEL, SERIAL_NUMBER, INSTALLATION_DATE, 
    LAST_MAINTENANCE_DATE, NEXT_MAINTENANCE_DATE, STATUS, 
    NOTES, CREATED_BY, IS_APPROVED, APPROVED_BY, APPROVED_DATE
) VALUES (
    'INS001', 'Digital Multimeter', 'Electronics', 'Lab Room 101', 
    'Fluke', '87V', 'FL12345', DATE '2023-01-15', 
    DATE '2024-06-01', DATE '2024-12-01', 1, 
    'Primary measurement instrument', 'System Admin', 1, 'System Admin', SYSDATE
);

INSERT INTO INSTRUMENTS (
    INSTRUMENT_CODE, INSTRUMENT_NAME, DEPARTMENT, LOCATION, 
    MANUFACTURER, MODEL, SERIAL_NUMBER, INSTALLATION_DATE, 
    LAST_MAINTENANCE_DATE, NEXT_MAINTENANCE_DATE, STATUS, 
    NOTES, CREATED_BY, IS_APPROVED, APPROVED_BY, APPROVED_DATE
) VALUES (
    'INS002', 'Oscilloscope', 'Electronics', 'Lab Room 102', 
    'Tektronix', 'TDS2024C', 'TEK67890', DATE '2023-03-20', 
    DATE '2024-05-15', DATE '2024-11-15', 2, 
    'Signal analysis equipment', 'System Admin', 1, 'System Admin', SYSDATE
);

INSERT INTO INSTRUMENTS (
    INSTRUMENT_CODE, INSTRUMENT_NAME, DEPARTMENT, LOCATION, 
    MANUFACTURER, MODEL, SERIAL_NUMBER, INSTALLATION_DATE, 
    LAST_MAINTENANCE_DATE, NEXT_MAINTENANCE_DATE, STATUS, 
    NOTES, CREATED_BY, IS_APPROVED
) VALUES (
    'INS003', 'Spectrum Analyzer', 'RF Engineering', 'Lab Room 201', 
    'Keysight', 'E4440A', 'KEY11111', DATE '2023-05-10', 
    DATE '2024-04-10', DATE '2024-10-10', 3, 
    'RF spectrum analysis', 'John Doe', 0
);

COMMIT;